<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RBA - ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    
    <style>
        body { font-family: 'Sarabun', 'Inter', sans-serif; }
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); width: 40px; height: 40px;
            border-radius: 50%; border-left-color: #0ea5e9; animation: spin 1s ease infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #message-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); z-index: 10000;
            display: none; justify-content: center; align-items: center;
        }
        .confetti {
            position: absolute; top: 0; left: 50%; width: 20px; height: 20px;
            font-size: 24px; opacity: 0; animation: fall 5s linear infinite;
        }
        @keyframes fall {
            0% { transform: translateY(-10vh) translateX(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(110vh) translateX(calc(100px * var(--tx))) rotate(720deg); opacity: 0; }
        }
        
        /* Socrative Grid Styles */
        .cell-correct { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; } /* Green-100/700 */
        .cell-wrong { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; } /* Red-100/700 */
        .cell-answered { background-color: #e0f2fe; color: #075985; border: 1px solid #bae6fd; } /* Sky-100/700 (Hidden Answer) */
        
        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #68D391;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #68D391;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app" class="w-full max-w-6xl mx-auto"> <!-- ‡∏Ç‡∏¢‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á -->

        <!-- Loading -->
        <div id="loading-overlay">
            <div class="spinner mb-4"></div>
            <p class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö...</p>
            <p class="text-xs text-gray-400 mt-2">v3.4 Socrative Style</p>
        </div>
        
        <!-- Modal -->
        <div id="message-modal">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md text-center mx-4">
                <div id="modal-icon" class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h3 id="modal-title" class="text-xl font-bold mb-2">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h3>
                <p id="modal-message" class="text-gray-600 mb-6 whitespace-pre-wrap text-sm text-left"></p>
                <button id="modal-close-btn" class="w-full bg-sky-600 text-white px-4 py-2 rounded-md hover:bg-sky-700 transition font-semibold">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>

        <!-- 1. Home -->
        <div id="page-home" class="page text-center bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-sky-700 mb-2">RBA Online Exam</h1>
            <p class="text-gray-600 mb-8">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
            <div class="flex flex-col md:flex-row gap-4 justify-center">
                <button id="btn-go-teacher" class="bg-sky-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-sky-700 transition shadow-md">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π (Teacher)</button>
                <button id="btn-go-student" class="bg-green-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-green-700 transition shadow-md">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (Student)</button>
            </div>
        </div>

        <!-- 2. Teacher Login -->
        <div id="page-teacher-login" class="page bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-center text-sky-700 mb-6">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á</label>
                    <input type="password" id="teacher-room-code" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-sky-500 outline-none" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á...">
                </div>
                <button id="btn-teacher-login" class="w-full bg-sky-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-sky-700 transition shadow-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button class="nav-home w-full text-center text-gray-600 hover:text-sky-600 transition mt-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            </div>
        </div>

        <!-- 3. Teacher Dashboard (Socrative Style) -->
        <div id="page-teacher-dashboard" class="page w-full">
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <!-- Header & Logout -->
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b pb-4">
                    <div>
                        <h2 class="text-3xl font-bold text-sky-700">‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö Real-time</h2>
                        <p class="text-gray-500 text-sm mt-1">‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö: <span class="font-semibold text-gray-700">RBA</span> | ‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö: <span id="student-count" class="font-bold text-sky-600">0</span> ‡∏Ñ‡∏ô</p>
                    </div>
                    <button class="nav-home bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300 transition font-semibold text-sm">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
                </div>

                <!-- Controls Bar -->
                <div class="flex flex-wrap gap-4 mb-6 items-center bg-gray-50 p-4 rounded-lg border border-gray-200">
                    
                    <!-- System Toggle -->
                    <button id="btn-toggle-system" class="flex-1 md:flex-none bg-gray-500 text-white px-4 py-2 rounded shadow transition text-sm font-medium min-w-[140px]">
                        <span id="txt-system-status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </button>

                    <div class="h-8 w-px bg-gray-300 hidden md:block"></div>

                    <!-- Socrative Toggles -->
                    <div class="flex items-center gap-2">
                        <label for="toggle-names" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="toggle-names" class="sr-only" checked>
                                <div class="w-10 h-6 bg-gray-400 rounded-full shadow-inner"></div>
                                <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition"></div>
                            </div>
                            <div class="ml-3 text-gray-700 text-sm font-medium">‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠</div>
                        </label>
                    </div>

                    <div class="flex items-center gap-2">
                        <label for="toggle-answers" class="flex items-center cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="toggle-answers" class="sr-only" checked>
                                <div class="w-10 h-6 bg-gray-400 rounded-full shadow-inner"></div>
                                <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition"></div>
                            </div>
                            <div class="ml-3 text-gray-700 text-sm font-medium">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏â‡∏•‡∏¢ (‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î)</div>
                        </label>
                    </div>

                    <div class="flex-1"></div> <!-- Spacer -->

                    <!-- Actions -->
                    <button id="btn-open-student-link" class="bg-blue-500 text-white px-4 py-2 rounded shadow hover:bg-blue-600 transition text-sm">Link ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    <button id="btn-download-excel" class="bg-teal-500 text-white px-4 py-2 rounded shadow hover:bg-teal-600 transition text-sm">‡πÇ‡∏´‡∏•‡∏î Excel</button>
                    <button id="btn-clear-data" class="bg-red-500 text-white px-4 py-2 rounded shadow hover:bg-red-600 transition text-sm">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </div>

                <!-- GRID TABLE -->
                <div class="overflow-x-auto rounded-lg border border-gray-300 shadow-inner max-h-[600px]">
                    <table class="w-full text-left border-collapse relative">
                        <thead class="bg-gray-100 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="p-3 border-b border-r border-gray-300 font-bold text-gray-600 text-sm min-w-[50px] bg-gray-100 sticky left-0 z-20">#</th>
                                <th class="p-3 border-b border-r border-gray-300 font-bold text-gray-600 text-sm min-w-[150px] bg-gray-100 sticky left-[50px] z-20 col-name">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                                <th class="p-3 border-b border-r border-gray-300 font-bold text-gray-600 text-sm text-center min-w-[80px]">‡∏ú‡∏•‡∏£‡∏ß‡∏°%</th>
                                <!-- Dynamic Question Headers JS will inject here -->
                                <th id="header-spacer" class="hidden"></th> 
                            </tr>
                        </thead>
                        <tbody id="grid-body" class="divide-y divide-gray-200 bg-white">
                            <tr><td colspan="18" class="p-8 text-center text-gray-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- 4. Student Login -->
        <div id="page-student-login" class="page bg-white p-8 rounded-xl shadow-lg max-w-md mx-auto">
            <h2 class="text-2xl font-bold text-center text-green-700 mb-6">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                    <input type="text" id="student-id" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-green-500 outline-none" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß...">
                </div>
                <button id="btn-student-login" class="w-full bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition shadow-sm">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏≠‡∏ö</button>
                <button class="nav-home w-full text-center text-gray-600 hover:text-sky-600 transition mt-2">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
            </div>
            <div id="student-preview" class="mt-4 text-center p-4 bg-gray-50 rounded-md hidden">
                <p class="font-semibold">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:</p><p id="preview-name" class="text-gray-700"></p><p id="preview-dept" class="text-gray-700"></p>
            </div>
        </div>

        <!-- 5. Exam Page -->
        <div id="page-student-exam" class="page bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-4xl mx-auto">
            <div class="flex justify-between items-start mb-6 border-b pb-4">
                 <div><h2 class="text-2xl font-bold text-green-700 mb-1">‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö RBA</h2><p class="text-gray-500 text-sm">‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å/‡∏ú‡∏¥‡∏î (True/False)</p></div>
                 <div class="text-right"><p id="exam-name" class="font-semibold text-gray-800"></p><p id="exam-dept" class="text-sm text-gray-600"></p><button id="btn-cancel-exam" class="mt-2 text-xs text-red-500 hover:underline">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å/‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button></div>
            </div>
            <p class="text-gray-600 mb-6 font-medium">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (15 ‡∏Ç‡πâ‡∏≠)</p>
            <form id="quiz-form" class="space-y-6"></form>
            <button id="btn-submit-exam" class="w-full bg-green-600 text-white px-6 py-4 rounded-md font-bold text-xl hover:bg-green-700 transition shadow-md mt-8">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
        </div>
        
        <!-- 6. Submitted -->
        <div id="page-submitted" class="page text-center bg-white p-8 md:p-12 rounded-xl shadow-lg max-w-lg mx-auto relative overflow-hidden">
            <div id="confetti-container" class="absolute inset-0"></div>
            <h2 id="submit-title" class="text-3xl font-bold text-green-700 mb-4">‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!</h2>
            <p class="text-lg text-gray-700 mb-6">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ö</p>
            <button class="nav-home bg-sky-600 text-white px-6 py-2 rounded-md font-semibold hover:bg-sky-700 transition">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        </div>
    </div>

    <div class="fixed bottom-2 right-2 text-xs text-gray-400 pointer-events-none select-none">v3.4 Socrative Dashboard</div>

    <style>
        /* Custom Toggle CSS */
        input:checked ~ .dot { transform: translateX(100%); background-color: #4ade80; }
        input:checked ~ .bg-gray-400 { background-color: #166534; }
    </style>

    <!-- SCRIPT START -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, getDocs, writeBatch, enableNetwork } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCr08U5KYGvxXu-DZ5qZOyVnU_1MJ-oY50",
            authDomain: "rba-online-6342e.firebaseapp.com",
            databaseURL: "https://rba-online-6342e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "rba-online-6342e",
            storageBucket: "rba-online-6342e.firebasestorage.app",
            messagingSenderId: "50383344070",
            appId: "1:50383344070:web:5003afe4c5530fc1d5a2c7",
            measurementId: "G-G75D8551FP"
        };

        const TEACHER_CODE = "RBA";
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/163RszY_6sDDQXxWiPlkw7g5HCj_U4N49H7CMCmzWPEw/export?format=csv&gid=0";
        
        const QUESTIONS = [
            { text: "1. RBA (Responsible Business Alliance) ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì‡πÅ‡∏´‡πà‡∏á‡∏û‡∏±‡∏ô‡∏ò‡∏°‡∏¥‡∏ï‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ú‡∏π‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö", answer: true },
            { text: "2. CORPORATE CODE OF CONDUCT ‡∏Ñ‡∏∑‡∏≠ ‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó", answer: true },
            { text: "3. ‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏ó‡∏ö‡∏±‡∏ç‡∏ç‡∏±‡∏ï‡∏¥‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°", answer: true },
            { text: "4. ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏ô‡πç‡∏≤‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á RBA ‡∏°‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏π‡πâ‡∏Ñ‡πâ‡∏≤‡∏Å‡∏±‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å RBA", answer: true },
            { text: "5. ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Ç‡∏≠‡∏áRBA ‡∏°‡∏µ‡∏ó‡∏±‡∏á‡πâ‡∏´‡∏°‡∏î 5 ‡∏™‡πà‡∏ß‡∏ô ‡∏Ñ‡∏∑‡∏≠ ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô, ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢, ‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°, ‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£, ‡∏à‡∏£‡∏¥‡∏¢‡∏ò‡∏£‡∏£‡∏°‡∏ó‡∏≤‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à", answer: true },
            { text: "6. ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏≠‡∏≤‡∏¢‡∏∏‡∏ï‡πç‡πà‡∏≤‡∏Å‡∏ß‡πà‡∏≤ 18 ‡∏õ‡∏µ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡πç‡∏≤‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πâ‡∏ú‡∏¥‡∏î‡∏à‡∏£‡∏£‡∏¢‡∏≤‡∏ö‡∏£‡∏£‡∏ì", answer: false },
            { text: "7. ‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏£‡πâ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏ò‡∏£‡∏£‡∏° ‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏π‡πà‡πÄ‡∏Ç‡πá‡∏ç‡∏ó‡∏≤‡∏á‡∏à‡∏¥‡∏ï‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏ß‡∏á‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏ó‡∏≤‡∏á‡πÄ‡∏û‡∏® ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏•‡∏∞‡πÄ‡∏°‡∏¥‡∏î‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏≤‡∏à‡∏≤‡∏ï‡πà‡∏≠‡πÅ‡∏£‡∏á‡∏á‡∏≤‡∏ô", answer: true },
            { text: "8. ‡∏´‡∏≤‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Å‡πá‡∏°‡∏µ‡∏Ç‡∏ß‡∏±‡∏ç‡πÅ‡∏•‡∏∞‡∏Å‡πç‡∏≤‡∏•‡∏±‡∏á‡πÉ‡∏à‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡πç‡∏≤‡∏á‡∏≤‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏Ç‡∏≠‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û‡∏°‡∏≤‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô", answer: true },
            { text: "9. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏ú‡∏•", answer: true },
            { text: "10. ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∂‡∏î‡∏ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢ ‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Å‡πç‡∏≤‡∏´‡∏ô‡∏î‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏à‡πç‡∏≤‡∏Å‡∏±‡∏î‡∏™‡∏≤‡∏£‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï ‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏°‡∏≤‡πÉ‡∏ä‡πâ‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå RoHS", answer: true },
            { text: "11. ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏™‡∏¥‡∏ô‡∏ö‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö ‡∏´‡∏≤‡∏Å‡∏ó‡πç‡∏≤‡πÉ‡∏´‡πâ‡∏á‡∏≤‡∏ô‡∏™‡πç‡∏≤‡πÄ‡∏£‡πá‡∏à‡∏•‡∏∏‡∏•‡πà‡∏ß‡∏á‡πÑ‡∏õ‡πÑ‡∏î‡πâ", answer: false },
            { text: "12. ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡∏•‡∏¥‡∏ï,‡∏™‡πà‡∏á‡∏°‡∏≠‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", answer: true },
            { text: "13. ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ñ‡∏≤‡∏£‡∏û‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ ‡πÇ‡∏î‡∏¢‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÅ‡∏≠‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏´‡∏£‡∏∑‡∏≠‡∏ô‡πç‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏ú‡∏¢‡πÅ‡∏û‡∏£‡πà‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏Å‡∏è‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏ñ‡∏π‡∏Å‡∏•‡∏á‡πÇ‡∏ó‡∏©", answer: true },
            { text: "14. ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡πç‡∏≤‡πÄ‡∏ô‡∏¥‡∏ô‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß", answer: true },
            { text: "15. ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Æ‡∏≤‡∏ô‡∏≤‡∏Ø ‡∏°‡∏µ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏Å‡∏≤‡∏£‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡∏Ç‡∏≠‡∏á‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ó‡∏≤‡∏á‡∏™‡∏±‡∏á‡∏Ñ‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏°‡πÅ‡∏Ç‡πá‡∏á", answer: true }
        ];

        let app, db, auth, user;
        let currentStudent = null, studentCache = null, quizStart = 0;
        let allResults = [], unsubStatus = null, unsubResults = null;
        let configRef, studentsRef; 
        
        // Dashboard State
        let showNames = true;
        let showAnswers = true;

        async function initSystem() {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                configRef = doc(db, 'rba_system_config', 'main');
                studentsRef = collection(db, 'rba_students');

                onAuthStateChanged(auth, (u) => {
                    if (u) {
                        user = u;
                        document.getElementById('loading-overlay').style.display = 'none';
                        if(window.location.hash === '#student') showPage('page-student-login');
                        else showPage('page-home');
                    } else {
                        signInAnonymously(auth).catch(handleAuthError);
                    }
                });
            } catch (e) { handleAuthError(e); }
        }

        function handleAuthError(error) {
            console.error("Auth Error:", error);
            let msg = `‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
            if (error.message.includes('operation-not-allowed')) msg = "‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Anonymous Auth ‡πÉ‡∏ô Firebase Console";
            else if (error.message.includes('api-key')) msg = "‚ö†Ô∏è API Key ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
            else if (error.message.includes('offline')) msg = "‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡πá‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ";
            document.getElementById('loading-overlay').style.display = 'none';
            showModal("‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á", msg);
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.style.display = 'none');
            document.getElementById(id).style.display = 'block';
            window.scrollTo(0,0);
        }

        function showModal(title, msg) {
            document.getElementById('modal-icon').textContent = title === "‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô" ? "‚ÑπÔ∏è" : "‚ö†Ô∏è";
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').innerText = msg;
            document.getElementById('message-modal').style.display = 'flex';
        }
        document.getElementById('modal-close-btn').onclick = () => document.getElementById('message-modal').style.display = 'none';

        document.getElementById('btn-go-teacher').onclick = () => showPage('page-teacher-login');
        document.getElementById('btn-go-student').onclick = () => showPage('page-student-login');
        document.querySelectorAll('.nav-home').forEach(b => b.onclick = () => {
            if(unsubStatus) unsubStatus();
            if(unsubResults) unsubResults();
            showPage('page-home');
        });

        document.getElementById('btn-teacher-login').onclick = () => {
            if(document.getElementById('teacher-room-code').value === TEACHER_CODE) {
                document.getElementById('teacher-room-code').value = '';
                showPage('page-teacher-dashboard');
                setupTeacherListeners();
            } else showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏£‡∏´‡∏±‡∏™‡∏´‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        };

        function setupTeacherListeners() {
            // Prepare Table Header (Dynamic 1-15)
            const theadRow = document.querySelector('thead tr');
            // Keep first 3 cols (Index, Name, Score)
            const baseHeaders = Array.from(theadRow.children).slice(0, 3);
            theadRow.innerHTML = '';
            baseHeaders.forEach(h => theadRow.appendChild(h));
            
            // Add Q1-Q15 Headers
            for(let i=1; i<=QUESTIONS.length; i++) {
                const th = document.createElement('th');
                th.className = "p-2 border-b border-r border-gray-300 text-center text-xs font-bold text-gray-500 min-w-[40px]";
                th.textContent = i;
                theadRow.appendChild(th);
            }

            // Toggle Listeners
            document.getElementById('toggle-names').addEventListener('change', (e) => {
                showNames = e.target.checked;
                renderGrid(allResults);
            });
            document.getElementById('toggle-answers').addEventListener('change', (e) => {
                showAnswers = e.target.checked;
                renderGrid(allResults);
            });

            // Firebase Listeners
            unsubStatus = onSnapshot(configRef, (snap) => {
                const isOpen = snap.exists() ? snap.data().isOpen : false;
                updateSystemButton(isOpen);
            }, (error) => {
                if(error.code === 'permission-denied') showModal("‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Test Mode ‡πÉ‡∏ô Firestore Rules");
            });

            const q = query(studentsRef);
            unsubResults = onSnapshot(q, (snap) => {
                let list = []; snap.forEach(d => list.push(d.data()));
                list.sort((a,b) => (a.score !== b.score) ? b.score - a.score : a.timeTaken - b.timeTaken);
                allResults = list;
                document.getElementById('student-count').textContent = list.length;
                renderGrid(list);
            });
        }

        function renderGrid(list) {
            const tbody = document.getElementById('grid-body');
            tbody.innerHTML = '';

            if(list.length === 0) {
                tbody.innerHTML = '<tr><td colspan="20" class="p-8 text-center text-gray-400">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>';
                return;
            }

            list.forEach((s, i) => {
                const tr = document.createElement('tr');
                
                // 1. Index
                const tdIdx = document.createElement('td');
                tdIdx.className = "p-3 border-b border-r border-gray-200 text-center text-sm font-medium bg-gray-50 sticky left-0 z-10";
                tdIdx.textContent = i + 1;
                tr.appendChild(tdIdx);

                // 2. Name
                const tdName = document.createElement('td');
                tdName.className = "p-3 border-b border-r border-gray-200 text-sm font-medium bg-gray-50 sticky left-[50px] z-10 min-w-[150px] truncate";
                tdName.textContent = showNames ? s.name : "Hidden Name";
                if(!showNames) tdName.classList.add("text-gray-400", "italic");
                tr.appendChild(tdName);

                // 3. Score %
                const tdScore = document.createElement('td');
                tdScore.className = `p-3 border-b border-r border-gray-200 text-center font-bold text-sm ${s.score===100 ? 'text-green-600' : 'text-gray-800'}`;
                tdScore.textContent = s.score.toFixed(0) + '%';
                tr.appendChild(tdScore);

                // 4. Question Columns (Grid)
                s.answers.forEach((isCorrect, idx) => {
                    const td = document.createElement('td');
                    td.className = "p-2 border-b border-r border-gray-200 text-center";
                    
                    const div = document.createElement('div');
                    div.className = "w-6 h-6 mx-auto rounded flex items-center justify-center text-xs font-bold transition-all duration-300";
                    
                    if (showAnswers) {
                        // Show Correct/Wrong Colors
                        if (isCorrect) {
                            div.className += " bg-green-100 text-green-700 border border-green-300";
                            div.textContent = "‚úî"; 
                        } else {
                            div.className += " bg-red-100 text-red-700 border border-red-300";
                            div.textContent = "‚úò";
                        }
                    } else {
                        // Show Neutral "Done" state
                        div.className += " bg-blue-50 text-blue-400 border border-blue-200";
                        // div.textContent = String.fromCharCode(65 + idx); // A, B, C... or just filled circle
                        div.textContent = "‚óè";
                    }
                    
                    td.appendChild(div);
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function updateSystemButton(isOpen) {
            const btn = document.getElementById('btn-toggle-system');
            const txt = document.getElementById('txt-system-status');
            if(isOpen) { txt.textContent = "‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö (‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö)"; btn.className = "flex-1 md:flex-none bg-yellow-500 text-white px-4 py-2 rounded shadow transition text-sm font-medium min-w-[140px] hover:bg-yellow-600"; }
            else { txt.textContent = "‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö)"; btn.className = "flex-1 md:flex-none bg-green-500 text-white px-4 py-2 rounded shadow transition text-sm font-medium min-w-[140px] hover:bg-green-600"; }
        }

        document.getElementById('btn-toggle-system').onclick = async () => {
            const btn = document.getElementById('btn-toggle-system');
            const originalText = document.getElementById('txt-system-status').textContent;
            document.getElementById('txt-system-status').textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            try { 
                const snap = await getDoc(configRef); 
                const cur = snap.exists() ? snap.data().isOpen : false; 
                await setDoc(configRef, { isOpen: !cur }); 
            } catch(e) { 
                document.getElementById('txt-system-status').textContent = originalText;
                showModal("Error", e.message); 
            }
        };
        document.getElementById('btn-open-student-link').onclick = () => { const url = window.location.href.split('#')[0] + '#student'; window.open(url, '_blank'); setTimeout(() => { if(!document.hidden) prompt("Copy Link ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:", url); }, 500); };
        document.getElementById('btn-download-excel').onclick = () => {
            if(allResults.length === 0) return showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            const data = allResults.map((s,i) => ({ "‡∏•‡∏≥‡∏î‡∏±‡∏ö": i+1, "‡∏£‡∏´‡∏±‡∏™": s.studentId, "‡∏ä‡∏∑‡πà‡∏≠": s.name, "‡πÅ‡∏ú‡∏ô‡∏Å": s.dept, "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô": s.score, "‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î": s.answers.map((v,k)=>v?-1:k+1).filter(x=>x>0).join(',')||'-', "‡πÄ‡∏ß‡∏•‡∏≤(‡∏ß‡∏¥)": s.timeTaken.toFixed(2), "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà": new Date(s.timestamp.seconds*1000).toLocaleString('th-TH') }));
            const ws = XLSX.utils.json_to_sheet(data); const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Results"); XLSX.writeFile(wb, "RBA_Results.xlsx");
        };
        document.getElementById('btn-clear-data').onclick = async () => {
            if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
            const batch = writeBatch(db); const snap = await getDocs(studentsRef); snap.forEach(d => batch.delete(d.ref)); batch.set(configRef, { isOpen: false }); await batch.commit(); showModal("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
        };

        async function getStudentList() {
            if(studentCache) return studentCache;
            try { const res = await fetch(SHEET_URL); const text = await res.text(); return new Promise((resolve) => { Papa.parse(text, { header: true, skipEmptyLines: true, transformHeader: h => h.trim().replace(/^\uFEFF/, ''), complete: (r) => { if(r.meta.fields.includes('‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß')) { studentCache = r.data; resolve(r.data); } else resolve([]); } }); }); } catch(e) { return []; }
        }

        document.getElementById('student-id').addEventListener('input', async (e) => {
            const id = e.target.value.trim(); const box = document.getElementById('student-preview');
            if(!id) { box.classList.add('hidden'); return; }
            const list = await getStudentList(); const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id);
            if(s) { document.getElementById('preview-name').textContent = s['‡∏ä‡∏∑‡πà‡∏≠']+' '+s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']; document.getElementById('preview-dept').textContent = s['‡πÅ‡∏ú‡∏ô‡∏Å']; box.classList.remove('hidden'); } else box.classList.add('hidden');
        });

        document.getElementById('btn-student-login').onclick = async () => {
            const btn = document.getElementById('btn-student-login');
            const originalText = btn.textContent;
            btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";
            btn.disabled = true;

            const id = document.getElementById('student-id').value.trim();
            if(!id) { resetBtn(); return showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™"); }
            
            try {
                const configSnap = await getDoc(configRef);
                if(!configSnap.exists() || !configSnap.data().isOpen) { resetBtn(); return showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "üî¥ ‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏™‡∏≠‡∏ö ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏î‡πÄ‡∏õ‡∏¥‡∏î‡∏£‡∏∞‡∏ö‡∏ö"); }
                const stdSnap = await getDoc(doc(studentsRef, id));
                if(stdSnap.exists()) { resetBtn(); return showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß"); }
                const list = await getStudentList(); const s = list.find(x => x['‡∏£‡∏´‡∏±‡∏™‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß'] == id);
                if(s) { 
                    currentStudent = { id: id, name: s['‡∏ä‡∏∑‡πà‡∏≠']+' '+s['‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'], dept: s['‡πÅ‡∏ú‡∏ô‡∏Å'] }; 
                    document.getElementById('exam-name').textContent = currentStudent.name; 
                    document.getElementById('exam-dept').textContent = currentStudent.dept; 
                    renderQuiz(); 
                    showPage('page-student-exam'); 
                    quizStart = Date.now(); 
                    resetBtn();
                } else { 
                    resetBtn(); return showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö"); 
                }
            } catch(e) {
                resetBtn();
                console.error(e);
                showModal("Error", "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + e.message);
            }

            function resetBtn() { btn.textContent = originalText; btn.disabled = false; }
        };

        function renderQuiz() {
            const f = document.getElementById('quiz-form'); f.innerHTML = '';
            QUESTIONS.forEach((q, i) => {
                const d = document.createElement('div'); d.className = "p-4 border rounded-lg bg-gray-50";
                d.innerHTML = `<p class="font-medium mb-3">${q.text}</p><div class="flex gap-4"><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="q${i}" value="true"> <span class="text-green-600 font-bold">‡∏ñ‡∏π‡∏Å</span></label><label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="q${i}" value="false"> <span class="text-red-600 font-bold">‡∏ú‡∏¥‡∏î</span></label></div>`;
                f.appendChild(d);
            });
        }

        document.getElementById('btn-cancel-exam').onclick = () => { if(confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å?")) { currentStudent = null; document.getElementById('student-id').value = ''; showPage('page-home'); } };

        document.getElementById('btn-submit-exam').onclick = async () => {
            let score = 0, answers = [], done = true;
            for(let i=0; i<QUESTIONS.length; i++) { const el = document.querySelector(`input[name="q${i}"]:checked`); if(!el) { done = false; break; } const val = el.value === 'true'; answers.push(val === QUESTIONS[i].answer); if(val === QUESTIONS[i].answer) score++; }
            if(!done) return showModal("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ç‡πâ‡∏≠");
            
            const btn = document.getElementById('btn-submit-exam');
            btn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö...";
            btn.disabled = true;

            const finalData = { studentId: currentStudent.id, name: currentStudent.name, dept: currentStudent.dept, score: (score/QUESTIONS.length)*100, answers: answers, timeTaken: (Date.now() - quizStart)/1000, timestamp: new Date() };
            try { await setDoc(doc(studentsRef, currentStudent.id), finalData); if(finalData.score === 100) { document.getElementById('submit-title').textContent = "‡∏™‡∏∏‡∏î‡∏¢‡∏≠‡∏î! 100 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°"; startConfetti(); } else { document.getElementById('submit-title').textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢"; } showPage('page-submitted'); } 
            catch(e) { btn.textContent = "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö"; btn.disabled = false; showModal("Error", "‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + e.message); }
        };

        function startConfetti() {
             const c = document.getElementById('confetti-container'); c.innerHTML = ''; const emo = ['üéâ','üéä','‚≠ê','üî•'];
             for(let i=0; i<40; i++) { const d = document.createElement('div'); d.className = 'confetti'; d.textContent = emo[Math.floor(Math.random()*emo.length)]; d.style.left = Math.random()*100+'%'; d.style.animationDelay = Math.random()*2+'s'; d.style.setProperty('--tx', (Math.random()-0.5)*5); c.appendChild(d); }
        }

        initSystem();
    </script>
</body>
</html>